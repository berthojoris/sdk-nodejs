(function(){
  var defaultOpts={endpoint:(typeof window!=='undefined'&&window.location?window.location.origin:'')+'/events',batchEndpoint:(typeof window!=='undefined'&&window.location?window.location.origin:'')+'/events/batch',appId:'app',batchSize:20,flushInterval:2000,maxPerSecond:50,useBeacon:true,optOut:false,sessionTimeout:1800000,attrName:'data-analytics',attrProps:'data-analytics-props',attrOn:'data-analytics-on',autoIdTracking:true}
  function now(){return Date.now()}
  function rid(){return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g,function(c){var r=Math.random()*16|0,v=c==='x'?r:(r&0x3|0x8);return v.toString(16)})}
  function storeGet(k){try{return localStorage.getItem(k)}catch(e){return null}}
  function storeSet(k,v){try{localStorage.setItem(k,v)}catch(e){}}
  function storeDel(k){try{localStorage.removeItem(k)}catch(e){}}
  function parsePropsStr(s){if(!s)return {};var p={};try{var j=JSON.parse(s);if(j&&typeof j==='object')return j}catch(e){}var parts=String(s).split(';');for(var i=0;i<parts.length;i++){var kv=parts[i].trim();if(!kv)continue;var idx=kv.indexOf('=');if(idx===-1){p[kv]=true;continue}var k=kv.slice(0,idx).trim();var v=kv.slice(idx+1).trim();p[k]=v}return p}
  function extractAnalyticsMeta(el,type,opts){if(!el)return null;var name=null;var props={};var a=el.getAttribute?el.getAttribute(opts.attrName):null;var on=el.getAttribute?el.getAttribute(opts.attrOn):null;if(a){name=a}if(on&&String(on).toLowerCase()!==String(type).toLowerCase())return null;if(!name){var cls=(el.className||'').toString();var m=cls.match(/(?:^|\s)(?:analytics-|track-)([^\s]+)/);if(m)name=m[1]}if(!name&&opts.autoIdTracking&&el.id&&type==='click'){name=el.id}var propStr=el.getAttribute?el.getAttribute(opts.attrProps):null;if(propStr)props=parsePropsStr(propStr);return name?{name:name,props:props}:null}
  function Analytics(opts){this.opts=Object.assign({},defaultOpts,opts||{});this.queue=[];this.lastSent=0;this.eventsInWindow=0;this.windowStart=now();this.userId=storeGet('analytics_uid')||rid();storeSet('analytics_uid',this.userId);this.sessionId=null;this.sessionActive=false;this.timer=null;this.online=true;this.initSession();this.bind()
  }
  Analytics.prototype.initSession=function(){var sid=storeGet('analytics_sid');var last=Number(storeGet('analytics_sid_last')||'0');if(!sid||!last||now()-last>this.opts.sessionTimeout){sid=rid()}this.sessionId=sid;this.sessionActive=true;storeSet('analytics_sid',sid);storeSet('analytics_sid_last',String(now()))}
  Analytics.prototype.touchSession=function(){storeSet('analytics_sid_last',String(now()))}
  Analytics.prototype.bind=function(){var self=this;if(typeof window==='undefined')return;window.addEventListener('click',function(e){var m=extractAnalyticsMeta(e.target,'click',self.opts);if(m){self.track(m.name,m.props);return}self.capture('click',serializeTarget(e.target))});window.addEventListener('scroll',throttle(function(){self.capture('scroll',{x:window.scrollX,y:window.scrollY})},500));window.addEventListener('input',throttle(function(e){var t=e.target;if(t&&t.type==='password')return;var m=extractAnalyticsMeta(t,'input',self.opts);if(m){self.track(m.name,m.props);return}var s=serializeTarget(t);if(typeof t.value==='string'){s.len=t.value.length}s.type=t.type||s.type;self.capture('input',s)},500));window.addEventListener('error',function(e){self.capture('error',{message:e.message,filename:e.filename,lineno:e.lineno,colno:e.colno})});window.addEventListener('unhandledrejection',function(e){self.capture('error',{message:String(e.reason)})});window.addEventListener('online',function(){self.online=true;self.flush()});window.addEventListener('offline',function(){self.online=false});window.addEventListener('popstate',function(){self.capture('navigation',{href:location.href})});window.addEventListener('hashchange',function(){self.capture('navigation',{href:location.href})});self.capture('pageview',{href:location.href,ref:document.referrer||null});self.start()
  }
  function throttle(fn,wait){var last=0;return function(){var t=now();if(t-last>=wait){last=t;fn.apply(this,arguments)}}}
  function serializeTarget(t){if(!t)return {};var o={tag:(t.tagName||'').toLowerCase(),id:t.id||null,cls:t.className||null,name:t.name||null};return o}
  Analytics.prototype.capture=function(type,payload){if(this.opts.optOut)return;this.touchSession();var e={appId:this.opts.appId,userId:this.userId,sessionId:this.sessionId,ts:now(),type:type,payload:payload||{}};this.push(e)}
  Analytics.prototype.track=function(name,properties){if(this.opts.optOut)return;this.touchSession();var e={appId:this.opts.appId,userId:this.userId,sessionId:this.sessionId,ts:now(),name:name,type:'custom',payload:properties||{}};this.push(e)}
  Analytics.prototype.push=function(e){var t=now();if(t-this.windowStart>=1000){this.windowStart=t;this.eventsInWindow=0}if(this.eventsInWindow>=this.opts.maxPerSecond)return;this.eventsInWindow++;this.queue.push(e);if(this.queue.length>=this.opts.batchSize)this.flush()}
  Analytics.prototype.start=function(){var self=this;if(self.timer)clearInterval(self.timer);self.timer=setInterval(function(){self.flush()},self.opts.flushInterval)}
  Analytics.prototype.stop=function(){if(this.timer)clearInterval(this.timer);this.timer=null}
  Analytics.prototype.flush=function(){if(!this.queue.length)return;if(!this.online){persistQueue(this.queue);return}var batch=this.queue.splice(0,this.opts.batchSize);var url=this.opts.batchEndpoint;var body=JSON.stringify(batch);var headers={'Content-Type':'application/json','X-App-Id':this.opts.appId};var ok=false;try{if(this.opts.useBeacon&&navigator&&navigator.sendBeacon){ok=navigator.sendBeacon(url,body)} }catch(e){}
  var self=this;if(!ok){fetch(url,{method:'POST',headers:headers,body:body}).catch(function(){persistQueue(batch)})}}
  function persistQueue(items){try{var q=JSON.parse(storeGet('analytics_queue')||'[]');q=q.concat(items);storeSet('analytics_queue',JSON.stringify(q))}catch(e){} }
  Analytics.prototype.flushStored=function(){try{var q=JSON.parse(storeGet('analytics_queue')||'[]');if(!q.length)return;storeSet('analytics_queue','[]');this.queue=this.queue.concat(q);this.flush()}catch(e){} }
  function create(opts){var a=new Analytics(opts||{});return a}
  if(typeof window!=='undefined'){window.AnalyticsSDK={create:create}}
  if(typeof module!=='undefined'&&module.exports){module.exports={create:create}}
})()